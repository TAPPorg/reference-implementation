name: Linux/MacOS Build

on: [push, pull_request]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/master'}} # don't cancel jobs on master

#env:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        build_type : [ Release, Debug ]
        os : [ macos-14, ubuntu-24.04 ]
        valgrind: [ true, false ]
        sanitize: [ true, false ]
        exclude:
          - valgrind : true
            sanitize : true
          - build_type : Release
            valgrind : true
          - build_type : Release
            sanitize : true
          - os: macos-14
            sanitize: true
          - os: macos-14
            valgrind: true
        include:
          - os: ubuntu-24.04
            cc: /usr/bin/gcc-14
            cxx: /usr/bin/g++-14
            cuda: true
            sanitize_flags: -fsanitize=address -fsanitize=leak -fsanitize=undefined -fno-omit-frame-pointer -fno-var-tracking
          - os: macos-14
            cc: clang
            cxx: clang++
            cuda: false
            sanitize_flags: -fsanitize=address -fsanitize=undefined -fno-omit-frame-pointer -fno-var-tracking

    name: "${{ matrix.valgrind && 'Valgrind' || matrix.sanitize && 'Sanitizers' || '' }} ${{ matrix.os }}: ${{ matrix.cxx }} ${{ matrix.build_type }}"
    runs-on: ${{ matrix.os }}
    env:
      CXX : ${{ matrix.cxx }}
      CC : ${{ matrix.cc }}
      DOXYGEN_VERSION : 1.9.1
      CCACHE_DIR : ${{github.workspace}}/build/.ccache
      CCACHE_COMPRESS : true
      CCACHE_COMPRESSLEVEL : 6
      BUILD_CONFIG : >
        -G Ninja
        -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
        -DCMAKE_UNITY_BUILD=${{ matrix.build_type == 'Debug' || matrix.valgrind }}
        -DTAPP_REFERENCE_ENABLE_TBLIS=ON
        -DTAPP_REFERENCE_BUILD_CUTENSOR_BINDS=${{ matrix.cuda && 'ON' || 'OFF' }}

    steps:
    - uses: actions/checkout@v4

    - name: Get CPU Model (Linux)
      if: ${{ startsWith(matrix.os, 'ubuntu') }}
      id: linux_cpu
      run: echo "CPU_MODEL=$(lscpu | grep 'Model name:' | cut -f 2 -d ':' | awk '{$1=$1}1')" >> $GITHUB_OUTPUT

    - name: Get CPU Model (macOS)
      if: ${{ startsWith(matrix.os, 'macos') }}
      id: macos_cpu
      # Using sysctl command to get the brand string
      run: echo "CPU_MODEL=$(sysctl -n machdep.cpu.brand_string)" >> $GITHUB_OUTPUT

    - name: Display CPU Model
      run: |
        echo "Runner OS: ${{ runner.os }}"
        if [ "${{ runner.os }}" == "Linux" ]; then
          echo "Processor Model: ${{ steps.linux_cpu.outputs.CPU_MODEL }}"
        elif [ "${{ runner.os }}" == "macOS" ]; then
          echo "Processor Model: ${{ steps.macos_cpu.outputs.CPU_MODEL }}"
        fi
      shell: bash

    - name: Create Build Environment
      # Some projects don't allow in-source building, so create a separate build directory
      # We'll use this as our working directory for all subsequent commands
      run: cmake -E make_directory ${{github.workspace}}/build

    - name: Set sanitizer flags
      if: ${{ matrix.sanitize }}
      shell: bash
      run: |
        if [[ '${{ matrix.sanitize }}' = 'true' ]]; then
          echo "CXXFLAGS=${{ matrix.sanitize_flags }}" >> "$GITHUB_ENV"
        fi

    - name: Install prerequisite MacOS packages
      if: ${{ startsWith(matrix.os, 'macos') }}
      run: brew install ninja ccache

    - name: Install prerequisites Ubuntu packages
      if: ${{ startsWith(matrix.os, 'ubuntu') }}
      run: |
        sudo apt-get update
        sudo apt-get install ninja-build g++-14 liblapack-dev ccache valgrind

    - name: Install prerequisites CUDA Toolkit (Ubuntu only)
      if: ${{ matrix.cuda }}
      run: |
        sudo apt-get install -y nvidia-cuda-toolkit

    - name: Set CUDA host compiler
      if: ${{ matrix.cuda }}
      run: |
        echo "CUDAHOSTCXX=${{ matrix.cxx }}" >> $GITHUB_ENV

    - name: Prepare ccache timestamp
      id: ccache_cache_timestamp
      shell: cmake -P {0}
      run: |
        string(TIMESTAMP current_date "%Y-%m-%d-%H;%M;%S" UTC)
        message("::set-output name=timestamp::${current_date}")
    - name: Setup ccache cache files
      uses: actions/cache@v4
      with:
        path: ${{github.workspace}}/build/.ccache
        key: ${{ matrix.config.name }}-ccache-${{ steps.ccache_cache_timestamp.outputs.timestamp }}
        restore-keys: |
          ${{ matrix.config.name }}-ccache-
    - name: Configure CMake
      # Use a bash shell so we can use the same syntax for environment variable
      # access regardless of the host operating system
      shell: bash
      working-directory: ${{github.workspace}}/build
      # Note the current convention is to use the -S and -B options here to specify source 
      # and build directories, but this is only available with CMake 3.13 and higher.  
      # The CMake binaries on the Github Actions machines are (as of this writing) 3.12
      run: cmake $GITHUB_WORKSPACE -DCMAKE_BUILD_TYPE=$BUILD_TYPE $BUILD_CONFIG


    - name: Build
      working-directory: ${{github.workspace}}/build
      shell: bash
      # Execute the build.  You can specify a specific target with "--target <NAME>"
      run: ccache -p && ccache -z && cmake --build . && ccache -s

    - name: Test
      if: ${{ !matrix.valgrind }}
      working-directory: ${{github.workspace}}/build
      shell: bash
      run: ctest --output-on-failure

    - name: Test (+ Valgrind)
      if: ${{ matrix.valgrind }}
      working-directory: ${{github.workspace}}/build
      shell: bash
      run: |
        cat > tblis.supp << 'EOF'
        # Suppress uninitialized value errors in TBLIS/BLIS packm functions
        # These occur in architecture-specific packing code (zen3, haswell, etc.)
        # and appear to be false positives in the BLIS library
        {
           tblis_packm_bsmtc_uninit
           Memcheck:Cond
           ...
           fun:*tblis*packm*bsmtc*
           ...
        }
        EOF
        valgrind --error-exitcode=1 --leak-check=full --suppressions=tblis.supp ./test++
